<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management | Admin</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .due-badge {
            background: #fee2e2;
            color: #ef4444;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
        }

        .paid-badge {
            background: #dcfce7;
            color: #22c55e;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
        }

        /* Dashboard Grid Styles */
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .class-card {
            background: white;
            border-radius: 15px;
            padding: 25px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #f1f5f9;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .class-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), #a855f7);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
            border-color: #e2e8f0;
        }

        .class-card:hover::before {
            opacity: 1;
        }

        .class-title {
            font-size: 20px;
            font-weight: 800;
            color: #1e293b;
            margin: 15px 0 5px;
        }

        .class-count {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .class-stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            font-size: 12px;
            padding-top: 15px;
            border-top: 1px solid #f8fafc;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 1px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.2s;
            width: fit-content;
        }

        .back-btn:hover {
            background: #f8fafc;
            color: var(--primary);
            border-color: var(--primary);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="layout">
        <div class="sidebar"></div>
        <main class="content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1>Student Management</h1>
                <div style="display: flex; gap: 10px;">
                    <a href="new-students.html" class="btn btn-secondary"><i class="fas fa-history"></i> Recent
                        Admissions</a>
                    <a href="#" class="btn btn-primary" onclick="showAddModal()">+ New Student</a>
                </div>
            </div>

            <!-- Class Dashboard View -->
            <div id="classDashboard" class="class-grid">
                <!-- Cards will be injected here -->
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;">
                    <i class="fas fa-circle-notch fa-spin fa-2x"></i>
                    <p style="margin-top: 10px;">Loading Classes...</p>
                </div>
            </div>

            <!-- Student List View -->
            <div id="studentsListView" style="display: none;">
                <button class="back-btn" onclick="showDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to All Classes
                </button>

                <div class="card" style="margin-bottom: 30px;">
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div style="flex: 1;">
                            <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 5px;">FILTER
                                BY
                                CLASS</label>
                            <select id="classFilter" onchange="loadStudents()">
                                <option value="">All Classes</option>
                                <option value="Nursery">Nursery</option>
                                <option value="LKG">LKG</option>
                                <option value="UKG">UKG</option>
                                <option value="Class 1">Class 1</option>
                                <option value="Class 2">Class 2</option>
                                <option value="Class 3">Class 3</option>
                                <option value="Class 4">Class 4</option>
                                <option value="Class 5">Class 5</option>
                                <option value="Class 6">Class 6</option>
                                <option value="Class 7">Class 7</option>
                                <option value="Class 8">Class 8</option>
                                <option value="Class 9">Class 9</option>
                                <option value="Class 10">Class 10</option>
                                <option value="Class 11">Class 11</option>
                                <option value="Class 12">Class 12</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 5px;">LATEST
                                STATUS</label>
                            <select id="statusFilter" onchange="loadStudents()">
                                <option value="all">All Status</option>
                                <option value="due">Due Fees Only</option>
                                <option value="paid">Fully Paid</option>
                            </select>
                        </div>
                        <div style="flex: 2;">
                            <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 5px;">SEARCH
                                NAME</label>
                            <input type="text" id="nameSearch" placeholder="Type student name..."
                                oninput="loadStudents()">
                        </div>
                    </div>
                </div>

                <div class="card" style="padding: 0; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0; text-align: left;">
                                <th style="padding: 15px;">Roll No</th>
                                <th style="padding: 15px;">Student Name</th>
                                <th style="padding: 15px;">Class</th>
                                <th style="padding: 15px;">Fees (Total/Paid)</th>
                                <th style="padding: 15px;">Status</th>
                                <th style="padding: 15px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Student Modal -->
    <div id="studentModal" class="modal"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:600px; max-height:90vh; overflow-y:auto; padding:30px;">
            <h3 id="modalTitle">Student Details</h3>
            <form id="studentForm" style="margin-top:20px;">
                <input type="hidden" id="studentId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Roll Number</label>
                        <input id="studRoll" type="text" placeholder="e.g. 101">
                    </div>
                    <div class="form-group">
                        <label>Student Name</label>
                        <input id="studName" type="text" required>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Class</label>
                        <select id="studClass" required>
                            <option value="Nursery">Nursery</option>
                            <option value="LKG">LKG</option>
                            <option value="UKG">UKG</option>
                            <option value="Class 1">Class 1</option>
                            <option value="Class 2">Class 2</option>
                            <option value="Class 3">Class 3</option>
                            <option value="Class 4">Class 4</option>
                            <option value="Class 5">Class 5</option>
                            <option value="Class 6">Class 6</option>
                            <option value="Class 7">Class 7</option>
                            <option value="Class 8">Class 8</option>
                            <option value="Class 9">Class 9</option>
                            <option value="Class 10">Class 10</option>
                            <option value="Class 11">Class 11</option>
                            <option value="Class 12">Class 12</option>
                        </select>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px; font-size: 13px; color: var(--primary);">Parents Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input id="studFather" type="text" placeholder="Father's Name">
                        <input id="studFatherMobile" type="text" placeholder="Father's Mobile">
                        <input id="studMother" type="text" placeholder="Mother's Name">
                        <input id="studMotherMobile" type="text" placeholder="Mother's Mobile">
                    </div>
                </div>

                <!-- Hidden legacy field if needed, but handled in JS -->
                <input type="hidden" id="studMobile">

                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px; font-size: 13px; color: var(--primary);">Third Contact (Guardian/Other)
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input id="studContactTitle" type="text" placeholder="Title (e.g. Uncle)">
                        <input id="studContactName" type="text" placeholder="Name">
                        <input id="studContactNumber" type="text" placeholder="Phone Number">
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px; font-size: 13px; color: var(--primary);">Official IDs & Admission</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input id="studAdmissionYear" type="text" placeholder="Admission Year (e.g. 2024-25)">
                        <input id="studScholarNo" type="text" placeholder="Scholar Number">
                        <input id="studAadhar" type="text" placeholder="Aadhar Number">
                        <input id="studSSSMID" type="text" placeholder="SSSMID">
                        <input id="studPEN" type="text" placeholder="PEN Number" style="grid-column: span 2;">
                    </div>
                </div>

                <div
                    style="background: #fff1f2; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #fecdd3;">
                    <h4 style="margin: 0 0 10px; font-size: 13px; color: #be123c;">Status Management</h4>
                    <p style="font-size:11px; color:#881337; margin-bottom:10px;">Select 'Active' for current students.
                        'TC Issued' or 'Passout' will move them to the Former Students archive.</p>
                    <select id="studStatus" style="width:100%; border-color:#e11d48;">
                        <option value="active">Active Student</option>
                        <option value="tc_issued">TC Issued (Student Left)</option>
                        <option value="passout">Passout (Alumni)</option>
                    </select>
                </div>

                <h4 style="margin: 20px 0 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Fees Configuration
                </h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Total Annual Fees</label>
                        <input id="studTotalFees" type="number" value="0">
                    </div>
                    <div class="form-group">
                        <label>Fees Paid</label>
                        <input id="studPaidFees" type="number" value="0">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" style="flex:1;"
                        onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { protectPage, initSidebar, api } from "./admin.js";

        async function init() {
            await protectPage();
            initSidebar();
            loadDashboard(); // Load dashboard first
        }

        let allStudentsCache = null; // Cache to avoid re-fetching when switching views

        window.loadDashboard = async () => {
            document.getElementById("classDashboard").style.display = "grid";
            document.getElementById("studentsListView").style.display = "none";

            try {
                // Fetch all students to generate stats
                if (!allStudentsCache) {
                    allStudentsCache = await api("/api/students");
                }
                const students = allStudentsCache;

                // Define Class Order
                const classOrder = [
                    "Nursery", "LKG", "UKG",
                    "Class 1", "Class 2", "Class 3", "Class 4", "Class 5",
                    "Class 6", "Class 7", "Class 8", "Class 9", "Class 10",
                    "Class 11", "Class 12"
                ];

                // Group Data
                const classStats = {};
                classOrder.forEach(c => classStats[c] = { total: 0, due: 0, paid: 0 });

                students.forEach(s => {
                    const c = s.className;
                    if (!classStats[c]) classStats[c] = { total: 0, due: 0, paid: 0 }; // Handle unknown classes
                    classStats[c].total++;
                    const dueAmt = (s.totalFees || 0) - (s.paidFees || 0);
                    if (dueAmt > 0) classStats[c].due++;
                    else classStats[c].paid++;
                });

                const dashboard = document.getElementById("classDashboard");
                dashboard.innerHTML = "";

                classOrder.forEach(cls => {
                    const stats = classStats[cls] || { total: 0, due: 0, paid: 0 };
                    const card = document.createElement("div");
                    card.className = "class-card";
                    card.onclick = () => openClass(cls);

                    // Icon selection
                    let icon = "fa-child";
                    if (cls.includes("Class 9") || cls.includes("10") || cls.includes("11") || cls.includes("12")) icon = "fa-user-graduate";
                    else if (cls.includes("Class 5") || cls.includes("6") || cls.includes("7") || cls.includes("8")) icon = "fa-user-astronaut";

                    // Display Name Mapping
                    let displayTitle = cls;
                    if (cls === "LKG") displayTitle = "LKG (KG-I)";
                    if (cls === "UKG") displayTitle = "UKG (KG-II)";

                    card.innerHTML = `
                        <div style="width: 50px; height: 50px; background: #f0fdf4; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: #16a34a;">
                            <i class="fas ${icon} fa-lg"></i>
                        </div>
                        <h3 class="class-title">${displayTitle}</h3>
                        <p class="class-count">${stats.total} Students</p>
                        <div class="class-stats">
                            <div class="stat-item" style="color: #ef4444;">
                                <i class="fas fa-exclamation-circle"></i> ${stats.due} Due
                            </div>
                            <div class="stat-item" style="color: #22c55e;">
                                <i class="fas fa-check-circle"></i> ${stats.paid} Paid
                            </div>
                        </div>
                    `;
                    dashboard.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                document.getElementById("classDashboard").innerHTML = `<p style="color:red">Error loading dashboard: ${err.message}</p>`;
            }
        }

        window.openClass = (className) => {
            document.getElementById("classDashboard").style.display = "none";
            document.getElementById("studentsListView").style.display = "block";

            const dropdown = document.getElementById("classFilter");
            dropdown.value = className;

            // Trigger load for this class
            loadStudents();
        }

        window.showDashboard = () => {
            loadDashboard();
        }

        window.loadStudents = async () => {
            const className = document.getElementById("classFilter").value;
            const status = document.getElementById("statusFilter").value;
            const search = document.getElementById("nameSearch").value.toLowerCase();

            // Improve: Use cache if we have it? 
            // The original logic used server filtering. 
            // If we have "thousands", server filtering is better for 'All Classes' but since we are drilled down, client filtering might be okay.
            // However, to keep consistency with existing logic (and support re-fetches after edits), let's stick to the API or handle it smartly.
            // For now, let's use the local cache 'allStudentsCache' if available to speed up filtering, 
            // BUT strict filtering usually requires API if the dataset is huge (server-side pagination). 
            // Given the current code fetches ALL without pagination, local filtering is FASTER.

            let data = [];
            if (allStudentsCache) {
                data = allStudentsCache;
            } else {
                // Fallback to fetch if direct access (though init calls dashboard first)
                let url = "/api/students";
                const params = new URLSearchParams();
                if (className) params.append("className", className); // Server optimization if supported
                if (status === "due") params.append("dueOnly", "true");
                const queryString = params.toString();
                if (queryString) url += "?" + queryString;
                data = await api(url);
            }

            // Client-side filtering (Robust)
            if (className) {
                data = data.filter(s => s.className === className);
            }
            if (status === "due") {
                data = data.filter(s => (s.totalFees || 0) - (s.paidFees || 0) > 0);
            } else if (status === "paid") {
                data = data.filter(s => (s.totalFees || 0) - (s.paidFees || 0) <= 0);
            }
            if (search) {
                data = data.filter(s => s.name.toLowerCase().includes(search));
            }

            const tbody = document.getElementById("studentTableBody");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="padding:20px; text-align:center;">No students found</td></tr>`;
                return;
            }

            data.forEach(s => {
                const due = (s.totalFees || 0) - (s.paidFees || 0);
                const tr = document.createElement("tr");
                tr.style.borderBottom = "1px solid #e2e8f0";
                tr.innerHTML = `
                    <td style="padding: 15px;">${s.rollNo || '-'}</td>
                    <td style="padding: 15px; font-weight: 700;">${s.name}</td>
                    <td style="padding: 15px;">${s.className}</td>
                    <td style="padding: 15px;">
                        <div style="font-weight:600;">₹${s.paidFees} / ₹${s.totalFees}</div>
                        ${due > 0 ? `<div style="font-size:11px; color:#ef4444;">Due: ₹${due}</div>` : ''}
                    </td>
                    <td style="padding: 15px;">
                        ${due > 0 ? `<span class="due-badge">DUE</span>` : `<span class="paid-badge">FULLY PAID</span>`}
                    </td>
                    <td style="padding: 15px;">
                        <button class="btn btn-secondary btn-sm" onclick="editStudent('${s._id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.showAddModal = () => {
            document.getElementById("studentForm").reset();
            document.getElementById("studentId").value = "";
            document.getElementById("modalTitle").innerText = "Add New Student";
            document.getElementById("studentModal").style.display = "flex";
        }

        window.closeModal = () => document.getElementById("studentModal").style.display = "none";

        document.getElementById("studentForm").onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById("studentId").value;
            const payload = {
                rollNo: document.getElementById("studRoll").value,
                name: document.getElementById("studName").value,
                className: document.getElementById("studClass").value,
                fatherName: document.getElementById("studFather").value,
                fatherMobile: document.getElementById("studFatherMobile").value,
                motherName: document.getElementById("studMother").value,
                motherMobile: document.getElementById("studMotherMobile").value,
                mobile: document.getElementById("studFatherMobile").value, // Sync primary
                contactPerson: {
                    title: document.getElementById("studContactTitle").value,
                    name: document.getElementById("studContactName").value,
                    number: document.getElementById("studContactNumber").value
                },
                admissionYear: document.getElementById("studAdmissionYear").value,
                scholarNumber: document.getElementById("studScholarNo").value,
                aadharNumber: document.getElementById("studAadhar").value,
                sssmId: document.getElementById("studSSSMID").value,
                penNumber: document.getElementById("studPEN").value,
                status: document.getElementById("studStatus").value,
                totalFees: Number(document.getElementById("studTotalFees").value),
                paidFees: Number(document.getElementById("studPaidFees").value)
            };

            try {
                if (id) await api(`/api/students?id=${id}`, { method: "PUT", body: JSON.stringify(payload) });
                else await api("/api/students", { method: "POST", body: JSON.stringify(payload) });
                closeModal();

                // Clear cache so dashboard updates
                allStudentsCache = null;

                // If in specific view, reload that view; otherwise dashboard
                if (document.getElementById("studentsListView").style.display !== "none") {
                    // Update cache for performance though
                    // Just reloading dashboard might be safer to sync all counts
                    loadDashboard();
                    // Or keep user in list view:
                    // allStudentsCache = await api("/api/students");
                    // loadStudents(); 
                } else {
                    loadDashboard();
                }
            } catch (err) { alert(err.message); }
        }

        window.editStudent = async (id) => {
            const s = await api(`/api/students?id=${id}`);
            document.getElementById("studentId").value = s._id;
            document.getElementById("studRoll").value = s.rollNo || "";
            document.getElementById("studName").value = s.name;
            document.getElementById("studClass").value = s.className;
            document.getElementById("studFather").value = s.fatherName || "";
            document.getElementById("studFatherMobile").value = s.fatherMobile || s.mobile || "";
            document.getElementById("studMother").value = s.motherName || "";
            document.getElementById("studMotherMobile").value = s.motherMobile || "";

            // New Fields
            const cp = s.contactPerson || {};
            document.getElementById("studContactTitle").value = cp.title || "";
            document.getElementById("studContactName").value = cp.name || "";
            document.getElementById("studContactNumber").value = cp.number || "";

            document.getElementById("studAdmissionYear").value = s.admissionYear || "";
            document.getElementById("studScholarNo").value = s.scholarNumber || "";
            document.getElementById("studAadhar").value = s.aadharNumber || "";
            document.getElementById("studSSSMID").value = s.sssmId || "";
            document.getElementById("studPEN").value = s.penNumber || "";

            // Status
            document.getElementById("studStatus").value = s.status || "active";

            document.getElementById("studTotalFees").value = s.totalFees || 0;
            document.getElementById("studPaidFees").value = s.paidFees || 0;
            document.getElementById("modalTitle").innerText = "Edit Student Info";
            document.getElementById("studentModal").style.display = "flex";
        }

        window.deleteStudent = async (id) => {
            if (!confirm("Delete this student record?")) return;
            await api(`/api/students?id=${id}`, { method: "DELETE" });
            allStudentsCache = null;
            if (document.getElementById("studentsListView").style.display !== "none") {
                let currentClass = document.getElementById("classFilter").value;
                // Refetch to be safe
                allStudentsCache = await api("/api/students");
                loadStudents();
            } else {
                loadDashboard();
            }
        }

        init();
    </script>
</body>

</html>